<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PVM & Gross Margin Bridge Tool</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div id="app">
        <!-- ============================================
             SCREEN 1: Landing / Disclaimer
             ============================================ -->
        <section id="screen-landing" class="screen active">
            <div class="container">
                <header class="landing-header">
                    <h1>Price‚ÄìVolume‚ÄìMix Bridge Tool</h1>
                    <p class="subtitle">Analyze revenue and margin drivers with full auditability</p>
                </header>

                <div class="disclaimer-box">
                    <h2>üîí 100% Local Processing</h2>
                    <ul>
                        <li><strong>No data leaves your computer.</strong> All processing happens in your browser.</li>
                        <li><strong>No internet required.</strong> Works offline after loading.</li>
                        <li><strong>No cloud, no APIs, no tracking.</strong> Your data stays yours.</li>
                        <li><strong>Auditable calculations.</strong> All formulas documented in output.</li>
                    </ul>
                    <p class="disclaimer-note">
                        This tool processes CSV files containing transaction-level data. 
                        Large files (GB-scale) are supported via streaming‚Äîyour computer's memory 
                        will not be overwhelmed.
                    </p>
                </div>

                <div class="mode-selection">
                    <h3>Select Analysis Mode</h3>
                    <div class="mode-buttons">
                        <button id="btn-mode-pvm" class="mode-btn selected" data-mode="pvm">
                            <span class="mode-icon">üìä</span>
                            <span class="mode-title">Sales PVM Bridge</span>
                            <span class="mode-desc">Price, Volume, Mix impact on Revenue</span>
                        </button>
                        <button id="btn-mode-gm" class="mode-btn" data-mode="gm">
                            <span class="mode-icon">üí∞</span>
                            <span class="mode-title">Gross Margin Bridge</span>
                            <span class="mode-desc">Margin drivers including Cost</span>
                        </button>
                    </div>
                </div>

                <button id="btn-start" class="btn-primary btn-large">
                    Get Started ‚Üí
                </button>
            </div>
        </section>

        <!-- ============================================
             SCREEN 2: File Upload & Column Mapping
             ============================================ -->
        <section id="screen-upload" class="screen">
            <div class="container">
                <header class="screen-header">
                    <button class="btn-back" data-target="screen-landing">‚Üê Back</button>
                    <h2>Step 1: Upload Your Data</h2>
                    <span class="mode-indicator" id="mode-indicator-upload"></span>
                </header>

                <div class="upload-area" id="upload-area">
                    <div class="upload-content">
                        <span class="upload-icon">üìÅ</span>
                        <p class="upload-text">Drag & drop your CSV or Excel file here</p>
                        <p class="upload-subtext">or click to browse (.csv, .xlsx, .xls)</p>
                        <input type="file" id="file-input" accept=".csv,.xlsx,.xls" hidden>
                    </div>
                </div>

                <div id="file-info" class="file-info hidden">
                    <div class="file-details">
                        <span class="file-name" id="file-name"></span>
                        <span class="file-size" id="file-size"></span>
                        <button class="btn-remove" id="btn-remove-file">‚úï</button>
                    </div>
                </div>

                <!-- Column Mapping Section -->
                <div id="column-mapping" class="column-mapping hidden">
                    <h3>Column Mapping</h3>
                    <p class="mapping-instructions">
                        We detected the following columns. Please confirm or adjust the mappings.
                    </p>

                    <div class="mapping-grid">
                        <div class="mapping-section required-mappings">
                            <h4>Required Columns</h4>
                            <div class="mapping-row">
                                <label for="map-date">Date</label>
                                <select id="map-date" data-field="date" class="column-select required"></select>
                            </div>
                            <div class="mapping-row">
                                <label for="map-sales">Sales (Revenue)</label>
                                <select id="map-sales" data-field="sales" class="column-select required"></select>
                            </div>
                            <div class="mapping-row">
                                <label for="map-quantity">Quantity (Volume)</label>
                                <select id="map-quantity" data-field="quantity" class="column-select required"></select>
                            </div>
                            <div class="mapping-row gm-only hidden">
                                <label for="map-cost">Cost</label>
                                <select id="map-cost" data-field="cost" class="column-select required"></select>
                            </div>
                        </div>

                        <div class="mapping-section dimension-mappings">
                            <h4>Dimension Columns (Optional)</h4>
                            <p class="dimension-instructions">Select columns to use as analysis dimensions</p>
                            <div id="dimension-checkboxes" class="dimension-list">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                    </div>

                    <!-- Date Format Confirmation -->
                    <div id="date-format-section" class="date-format-section hidden">
                        <h4>Date Format Detected</h4>
                        <div class="date-format-preview">
                            <p>Sample dates from your file:</p>
                            <ul id="date-samples" class="date-samples"></ul>
                        </div>
                        <div class="date-format-confirm">
                            <label for="date-format-select">Detected format:</label>
                            <select id="date-format-select">
                                <option value="auto">Auto-detect</option>
                                <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                <option value="DD-MMM-YYYY">DD-MMM-YYYY (e.g., 15-Jan-2024)</option>
                                <option value="MMM DD, YYYY">MMM DD, YYYY (e.g., Jan 15, 2024)</option>
                            </select>
                            <p id="date-parse-preview" class="date-parse-preview"></p>
                        </div>
                    </div>
                </div>

                <div class="screen-actions">
                    <button id="btn-to-periods" class="btn-primary" disabled>
                        Continue to Period Setup ‚Üí
                    </button>
                </div>
            </div>
        </section>

        <!-- ============================================
             SCREEN 3: Period Configuration
             ============================================ -->
        <section id="screen-periods" class="screen">
            <div class="container">
                <header class="screen-header">
                    <button class="btn-back" data-target="screen-upload">‚Üê Back</button>
                    <h2>Step 2: Configure Time Periods</h2>
                    <span class="mode-indicator" id="mode-indicator-periods"></span>
                </header>

                <div class="period-config">
                    <div class="config-section">
                        <h3>Fiscal Year End</h3>
                        <p>Which month does your fiscal year end?</p>
                        <select id="fy-end-month" class="fy-select">
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12" selected>December</option>
                        </select>
                    </div>

                    <div class="config-section">
                        <h3>Data Date Range</h3>
                        <div id="date-range-info" class="date-range-info">
                            <p>Scanning file to determine date range...</p>
                        </div>
                    </div>

                    <!-- Multi-Year Selection (shown when multiple complete years detected) -->
                    <div class="config-section" id="multi-year-section" style="display: none;">
                        <h3>Select Fiscal Years for Analysis</h3>
                        <p>Select which fiscal years to include in your multi-year analysis:</p>
                        <div id="fiscal-year-checkboxes" class="fiscal-year-selection">
                            <!-- Populated dynamically with fiscal year checkboxes -->
                        </div>
                        <p class="period-help" style="margin-top: 12px; font-size: 0.9em; color: var(--color-muted);">
                            Select at least 2 years to enable multi-year analysis.
                        </p>
                    </div>

                    <!-- Two-Period Configuration (shown when single year or user preference) -->
                    <div id="two-period-config">
                        <div class="config-section">
                            <h3>Current Period Type</h3>
                            <label class="checkbox-label">
                                <input type="checkbox" id="use-ltm-period" checked>
                                Use LTM (Last Twelve Months) for current period
                            </label>
                            <p class="period-help" style="margin-top: 8px; font-size: 0.9em; color: var(--color-muted);">
                                When unchecked, the current period will use a full fiscal year instead of LTM.
                            </p>
                        </div>

                        <div class="config-section" id="ltm-config-section">
                            <h3>LTM End Date</h3>
                            <p>Confirm the end date for Last Twelve Months calculation:</p>
                            <input type="date" id="ltm-end-date" class="date-input">
                            <p class="ltm-help">
                                LTM period will be: <span id="ltm-range-preview">--</span>
                            </p>
                        </div>

                        <div class="config-section" id="cy-fiscal-year-section" style="display: none;">
                            <h3>Current Fiscal Year</h3>
                            <p>Select the fiscal year for the current period:</p>
                            <input type="number" id="cy-fiscal-year" class="date-input" min="2000" max="2100" style="width: 120px;">
                            <p class="cy-help">
                                Current FY period will be: <span id="cy-range-preview">--</span>
                            </p>
                        </div>

                        <div class="config-section">
                            <h3>Prior Fiscal Year</h3>
                            <div id="pfy-info" class="pfy-info">
                                <p>Prior Fiscal Year: <span id="pfy-range">--</span></p>
                            </div>
                        </div>
                    </div>

                    <div class="period-summary" id="period-summary">
                        <!-- Populated after configuration -->
                    </div>
                </div>

                <div class="screen-actions">
                    <button id="btn-to-lod" class="btn-primary" disabled>
                        Continue to Level of Detail ‚Üí
                    </button>
                </div>
            </div>
        </section>

        <!-- ============================================
             SCREEN 4: Level of Detail Selection
             ============================================ -->
        <section id="screen-lod" class="screen">
            <div class="container">
                <header class="screen-header">
                    <button class="btn-back" data-target="screen-periods">‚Üê Back</button>
                    <h2>Step 3: Select Level of Detail</h2>
                    <span class="mode-indicator" id="mode-indicator-lod"></span>
                </header>

                <div class="lod-config">
                    <p class="lod-instructions">
                        Select which dimensions to include in your analysis. 
                        The bridge will be calculated at this level of detail.
                    </p>

                    <div class="lod-selection" id="lod-selection">
                        <!-- Populated with dimension checkboxes -->
                    </div>

                    <div id="lod-warning" class="lod-warning hidden">
                        <span class="warning-icon">‚ö†Ô∏è</span>
                        <span class="warning-text">
                            Selecting many dimensions may result in a large number of combinations.
                            Processing may take longer on large files.
                        </span>
                    </div>

                    <div class="lod-preview">
                        <h4>Analysis Preview</h4>
                        <p id="lod-preview-text">Select at least one dimension to see preview.</p>
                    </div>

                    <!-- GM-specific: Price Definition -->
                    <div id="gm-price-definition" class="gm-options hidden">
                        <h4>Gross Margin Price Definition</h4>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="gm-price-def" value="margin-per-unit" checked>
                                <span class="radio-label">
                                    <strong>Margin per Unit</strong>
                                    <span class="radio-desc">(Sales ‚àí Cost) / Quantity</span>
                                </span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="gm-price-def" value="sales-per-unit">
                                <span class="radio-label">
                                    <strong>Sales Price per Unit</strong>
                                    <span class="radio-desc">Sales / Quantity (Cost analyzed separately)</span>
                                </span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="screen-actions">
                    <button id="btn-process" class="btn-primary btn-large">
                        üöÄ Run Analysis
                    </button>
                </div>
            </div>
        </section>

        <!-- ============================================
             SCREEN 5: Processing
             ============================================ -->
        <section id="screen-processing" class="screen">
            <div class="container">
                <header class="screen-header">
                    <h2>Processing Your Data</h2>
                </header>

                <div class="processing-status">
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <div class="progress-text">
                            <span id="progress-percent">0%</span>
                            <span id="progress-rows">0 rows processed</span>
                        </div>
                    </div>

                    <div class="processing-stages">
                        <div class="stage" id="stage-parsing">
                            <span class="stage-icon">‚è≥</span>
                            <span class="stage-text">Parsing CSV</span>
                        </div>
                        <div class="stage" id="stage-aggregating">
                            <span class="stage-icon">‚è≥</span>
                            <span class="stage-text">Aggregating by LOD</span>
                        </div>
                        <div class="stage" id="stage-calculating">
                            <span class="stage-icon">‚è≥</span>
                            <span class="stage-text">Calculating Bridge</span>
                        </div>
                        <div class="stage" id="stage-finalizing">
                            <span class="stage-icon">‚è≥</span>
                            <span class="stage-text">Finalizing Results</span>
                        </div>
                    </div>

                    <div class="processing-stats" id="processing-stats">
                        <!-- Real-time stats -->
                    </div>

                    <button id="btn-cancel" class="btn-secondary">
                        Cancel Processing
                    </button>
                </div>
            </div>
        </section>

        <!-- ============================================
             SCREEN 6: Results
             ============================================ -->
        <section id="screen-results" class="screen">
            <div class="container wide">
                <header class="screen-header">
                    <button class="btn-back" data-target="screen-lod">‚Üê Adjust Settings</button>
                    <h2>Analysis Results</h2>
                    <div class="header-actions">
                        <button id="btn-export-excel" class="btn-primary">
                            üì• Export to Excel
                        </button>
                    </div>
                </header>

                <!-- Results Tabs -->
                <div class="results-tabs">
                    <button class="tab-btn active" data-tab="summary">Summary Bridge</button>
                    <button class="tab-btn" data-tab="detail">Detail by LOD</button>
                    <button class="tab-btn" data-tab="negatives">Negative Values</button>
                    <button class="tab-btn" data-tab="assumptions">Assumptions</button>
                </div>

                <!-- Tab: Summary Bridge -->
                <div class="tab-content active" id="tab-summary">
                    <div class="summary-cards">
                        <div class="summary-card">
                            <span class="card-label">Prior Year</span>
                            <span class="card-value" id="summary-py-value">--</span>
                            <span class="card-period" id="summary-py-period">--</span>
                        </div>
                        <div class="summary-card">
                            <span class="card-label">LTM</span>
                            <span class="card-value" id="summary-cy-value">--</span>
                            <span class="card-period" id="summary-cy-period">--</span>
                        </div>
                        <div class="summary-card highlight">
                            <span class="card-label">Change</span>
                            <span class="card-value" id="summary-change-value">--</span>
                            <span class="card-pct" id="summary-change-pct">--</span>
                        </div>
                    </div>

                    <div class="bridge-table-container">
                        <h3>Bridge Summary</h3>
                        <table class="bridge-table" id="bridge-summary-table">
                            <thead>
                                <tr>
                                    <th>Component</th>
                                    <th class="num">Impact</th>
                                    <th class="num">% of Change</th>
                                </tr>
                            </thead>
                            <tbody id="bridge-summary-body">
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Detail by LOD -->
                <div class="tab-content" id="tab-detail">
                    <div class="detail-controls">
                        <div class="search-box">
                            <input type="text" id="detail-search" placeholder="Search...">
                        </div>
                        <div class="sort-controls">
                            <label>Sort by:</label>
                            <select id="detail-sort">
                                <option value="total-desc">Total Impact (High to Low)</option>
                                <option value="total-asc">Total Impact (Low to High)</option>
                                <option value="price-desc">Price Impact (High to Low)</option>
                                <option value="volume-desc">Volume Impact (High to Low)</option>
                                <option value="mix-desc">Mix Impact (High to Low)</option>
                            </select>
                        </div>
                    </div>

                    <div class="detail-table-container">
                        <table class="detail-table" id="detail-table">
                            <thead id="detail-table-head">
                                <!-- Dynamic columns based on LOD -->
                            </thead>
                            <tbody id="detail-table-body">
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>
                    </div>

                    <div class="pagination" id="detail-pagination">
                        <!-- Pagination controls -->
                    </div>
                </div>

                <!-- Tab: Negative Values -->
                <div class="tab-content" id="tab-negatives">
                    <div class="negatives-explanation">
                        <p>
                            Rows with Sales ‚â§ 0 or Quantity ‚â§ 0 are excluded from standard PVM calculations
                            and shown here separately. These may represent returns, adjustments, or data errors.
                        </p>
                    </div>

                    <div class="negatives-summary" id="negatives-summary">
                        <!-- Summary stats -->
                    </div>

                    <table class="negatives-table" id="negatives-table">
                        <thead>
                            <tr>
                                <th>Period</th>
                                <th>Type</th>
                                <th class="num">Count</th>
                                <th class="num">Total Sales</th>
                                <th class="num">Total Quantity</th>
                            </tr>
                        </thead>
                        <tbody id="negatives-table-body">
                            <!-- Populated dynamically -->
                        </tbody>
                    </table>
                </div>

                <!-- Tab: Assumptions -->
                <div class="tab-content" id="tab-assumptions">
                    <div class="assumptions-content">
                        <h3>Analysis Configuration</h3>
                        <table class="assumptions-table">
                            <tbody id="assumptions-config">
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>

                        <h3>Calculation Methodology</h3>
                        <div class="methodology" id="methodology-content">
                            <!-- Methodology explanation -->
                        </div>

                        <h3>Data Quality Notes</h3>
                        <div class="data-quality" id="data-quality-content">
                            <!-- Data quality notes -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================
             Error Modal
             ============================================ -->
        <div id="error-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>‚ö†Ô∏è Error</h3>
                    <button class="modal-close" id="error-modal-close">‚úï</button>
                </div>
                <div class="modal-body" id="error-modal-body">
                    <!-- Error message -->
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" id="error-modal-ok">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/period-utils.js"></script>
    <script src="js/csv-parser.js"></script>
    <script src="js/excel-parser.js"></script>
    <script src="js/aggregator.js"></script>
    <script src="js/bridge-calculator.js"></script>
    <script src="js/ui-renderer.js"></script>
    <script src="js/excel-export.js"></script>
    <script src="js/app.js"></script>
    <script src="js/app2.js"></script>
</body>
</html>
